<!DOCTYPE html>
<html lang="en">
<head><!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>UK EV Brand GEO Rankings - Live</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useMemo, useEffect } = React;

    const Download = ({ size = 24 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
        <polyline points="7 10 12 15 17 10"></polyline>
        <line x1="12" y1="15" x2="12" y2="3"></line>
      </svg>
    );

    const SimpleLLMDashboard = () => {
      const [rawData, setRawData] = useState([]);
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState(null);
      const [sortConfig, setSortConfig] = useState({ key: 'overallRank', direction: 'asc' });

      // Fetch data from Airtable
      useEffect(() => {
        const fetchAirtableData = async () => {
          try {
            setLoading(true);
            const response = await fetch('https://api.airtable.com/v0/app0HlKtwm3uxEOLA/Table%201', {
              headers: {
                'Authorization': 'Bearer patznUyd4Le6SJFpw.61f5f1eb74555d4d4fcde1a7c4dde19aed6b29d0784978cb152de981d16c0aa4'
              }
            });

            if (!response.ok) {
              throw new Error('Failed to fetch data from Airtable');
            }

            const data = await response.json();
            setRawData(data.records);
            setLoading(false);
          } catch (err) {
            setError(err.message);
            setLoading(false);
          }
        };

        fetchAirtableData();
      }, []);

      // Calculate brand metrics from raw data
      const brandData = useMemo(() => {
        if (rawData.length === 0) return [];

        const brandStats = {};
        const timestamps = new Set();

        // Process each record
        rawData.forEach(record => {
          const fields = record.fields;
          const timestamp = fields.Timestamp;
          const rank = fields.Rank;

          timestamps.add(timestamp);

          // Process each model
          ['Qwen', 'Deepseek', 'Gemini'].forEach(model => {
            const brand = fields[model];
            if (!brand) return;

            if (!brandStats[brand]) {
              brandStats[brand] = {
                qwen: { ranks: [], top5: 0, total: 0 },
                deepseek: { ranks: [], top5: 0, total: 0 },
                gemini: { ranks: [], top5: 0, total: 0 },
                overall: { ranks: [], top5: 0, total: 0 }
              };
            }

            const modelKey = model.toLowerCase();
            brandStats[brand][modelKey].ranks.push(rank);
            brandStats[brand][modelKey].total++;
            if (rank <= 5) brandStats[brand][modelKey].top5++;

            brandStats[brand].overall.ranks.push(rank);
            brandStats[brand].overall.total++;
            if (rank <= 5) brandStats[brand].overall.top5++;
          });
        });

        // Calculate averages and percentages
        const results = [];
        Object.keys(brandStats).forEach(brand => {
          const stats = brandStats[brand];

          const avgRank = (key) => {
            const ranks = stats[key].ranks;
            return ranks.length > 0 ? ranks.reduce((a, b) => a + b, 0) / ranks.length : null;
          };

          const top5Pct = (key) => {
            const total = stats[key].total;
            return total > 0 ? (stats[key].top5 / total) * 100 : null;
          };

          results.push({
            brand,
            qwenRank: avgRank('qwen'),
            deepseekRank: avgRank('deepseek'),
            geminiRank: avgRank('gemini'),
            overallRank: avgRank('overall'),
            overallTop5: top5Pct('overall')
          });
        });

        return results;
      }, [rawData]);

      const handleSort = (key) => {
        setSortConfig(prev => ({
          key,
          direction: prev.key === key && prev.direction === 'asc' ? 'desc' : 'asc'
        }));
      };

      const sortedData = useMemo(() => {
        return [...brandData].sort((a, b) => {
          const aVal = a[sortConfig.key];
          const bVal = b[sortConfig.key];
          
          // Handle null values (N/A) - push them to the end
          if (aVal === null && bVal === null) return 0;
          if (aVal === null) return 1;
          if (bVal === null) return -1;
          
          if (sortConfig.direction === 'asc') {
            return aVal - bVal;
          } else {
            return bVal - aVal;
          }
        });
      }, [brandData, sortConfig]);

      const SortIcon = ({ column }) => {
        if (sortConfig.key !== column) {
          return React.createElement('span', { className: "text-white opacity-50 ml-1" }, '‚áÖ');
        }
        return sortConfig.direction === 'asc' ? 
          React.createElement('span', { className: "text-white ml-1" }, '‚Üë') : 
          React.createElement('span', { className: "text-white ml-1" }, '‚Üì');
      };

      const formatValue = (value) => {
        return value !== null ? value.toFixed(2) : 'N/A';
      };

      const formatPercentage = (value) => {
        return value !== null ? value.toFixed(1) + '%' : 'N/A';
      };

      const exportToCSV = () => {
        const headers = ['Brand', 'Qwen Avg Rank', 'DeepSeek Avg Rank', 'Gemini Avg Rank', 'Overall Avg Rank', 'Overall Top 5 %'];
        const rows = sortedData.map(row => [
          row.brand,
          row.qwenRank !== null ? row.qwenRank.toFixed(2) : 'N/A',
          row.deepseekRank !== null ? row.deepseekRank.toFixed(2) : 'N/A',
          row.geminiRank !== null ? row.geminiRank.toFixed(2) : 'N/A',
          row.overallRank !== null ? row.overallRank.toFixed(2) : 'N/A',
          row.overallTop5 !== null ? row.overallTop5.toFixed(1) + '%' : 'N/A'
        ]);

        const csvContent = [
          headers.join(','),
          ...rows.map(row => row.join(','))
        ].join('\n');

        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'uk_ev_brand_geo_rankings.csv';
        a.click();
      };

      if (loading) {
        return (
          <div className="w-full min-h-screen bg-gradient-to-br from-gray-50 to-blue-50 flex items-center justify-center">
            <div className="text-center">
              <div className="text-4xl font-black mb-4" style={{ fontFamily: 'Arial Black, sans-serif', color: '#003478' }}>
                LOADING DATA...
              </div>
              <div className="text-gray-600">Fetching live data from Airtable</div>
            </div>
          </div>
        );
      }

      if (error) {
        return (
          <div className="w-full min-h-screen bg-gradient-to-br from-gray-50 to-blue-50 flex items-center justify-center">
            <div className="text-center bg-white p-8 rounded shadow-lg">
              <div className="text-2xl font-black mb-4 text-red-600" style={{ fontFamily: 'Arial Black, sans-serif' }}>
                ERROR LOADING DATA
              </div>
              <div className="text-gray-600">{error}</div>
            </div>
          </div>
        );
      }

      return (
        <div className="w-full min-h-screen bg-gradient-to-br from-gray-50 to-blue-50">
          <div className="text-white py-8 px-6 shadow-2xl border-b-2" style={{ backgroundColor: '#003478', borderBottomColor: '#0055aa' }}>
            <div className="max-w-6xl mx-auto">
              <div className="flex justify-between items-center">
                <div>
                  <h1 className="text-4xl font-black tracking-tight" style={{ fontFamily: 'Arial Black, sans-serif' }}>
                    UK EV BRAND GEO RANKINGS
                  </h1>
                  <p className="text-blue-200 mt-1 text-lg font-semibold">
                    Live Data from Airtable
                  </p>
                </div>
                <div className="bg-green-500 text-white px-4 py-2 rounded font-bold text-sm">
                  ‚óè LIVE
                </div>
              </div>
            </div>
          </div>

          <div className="max-w-6xl mx-auto p-6">
            <div className="bg-white shadow-2xl border-l-4" style={{ borderLeftColor: '#003478' }}>
              <div className="p-6 border-b border-gray-200 flex justify-between items-center">
                <div>
                  <h2 className="text-2xl font-black" style={{ fontFamily: 'Arial Black, sans-serif', color: '#003478' }}>
                    BRAND RANKINGS
                  </h2>
                  <p className
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>UK EV Brand GEO Rankings - Live</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useMemo, useEffect } = React;

    const Download = ({ size = 24 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
        <polyline points="7 10 12 15 17 10"></polyline>
        <line x1="12" y1="15" x2="12" y2="3"></line>
      </svg>
    );

    const SimpleLLMDashboard = () => {
      const [rawData, setRawData] = useState([]);
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState(null);
      const [sortConfig, setSortConfig] = useState({ key: 'overallRank', direction: 'asc' });

      // Fetch data from Airtable
      useEffect(() => {
        const fetchAirtableData = async () => {
          try {
            setLoading(true);
            const response = await fetch('https://api.airtable.com/v0/app0HlKtwm3uxEOLA/Table%201', {
              headers: {
                'Authorization': 'Bearer patznUyd4Le6SJFpw.61f5f1eb74555d4d4fcde1a7c4dde19aed6b29d0784978cb152de981d16c0aa4'
              }
            });

            if (!response.ok) {
              throw new Error('Failed to fetch data from Airtable');
            }

            const data = await response.json();
            setRawData(data.records);
            setLoading(false);
          } catch (err) {
            setError(err.message);
            setLoading(false);
          }
        };

        fetchAirtableData();
      }, []);

      // Calculate brand metrics from raw data
      const brandData = useMemo(() => {
        if (rawData.length === 0) return [];

        const brandStats = {};
        const timestamps = new Set();

        // Process each record
        rawData.forEach(record => {
          const fields = record.fields;
          const timestamp = fields.Timestamp;
          const rank = fields.Rank;

          timestamps.add(timestamp);

          // Process each model
          ['Qwen', 'Deepseek', 'Gemini'].forEach(model => {
            const brand = fields[model];
            if (!brand) return;

            if (!brandStats[brand]) {
              brandStats[brand] = {
                qwen: { ranks: [], top5: 0, total: 0 },
                deepseek: { ranks: [], top5: 0, total: 0 },
                gemini: { ranks: [], top5: 0, total: 0 },
                overall: { ranks: [], top5: 0, total: 0 }
              };
            }

            const modelKey = model.toLowerCase();
            brandStats[brand][modelKey].ranks.push(rank);
            brandStats[brand][modelKey].total++;
            if (rank <= 5) brandStats[brand][modelKey].top5++;

            brandStats[brand].overall.ranks.push(rank);
            brandStats[brand].overall.total++;
            if (rank <= 5) brandStats[brand].overall.top5++;
          });
        });

        // Calculate averages and percentages
        const results = [];
        Object.keys(brandStats).forEach(brand => {
          const stats = brandStats[brand];

          const avgRank = (key) => {
            const ranks = stats[key].ranks;
            return ranks.length > 0 ? ranks.reduce((a, b) => a + b, 0) / ranks.length : 999;
          };

          const top5Pct = (key) => {
            const total = stats[key].total;
            return total > 0 ? (stats[key].top5 / total) * 100 : 0;
          };

          results.push({
            brand,
            qwenRank: avgRank('qwen'),
            deepseekRank: avgRank('deepseek'),
            geminiRank: avgRank('gemini'),
            overallRank: avgRank('overall'),
            overallTop5: top5Pct('overall')
          });
        });

        return results;
      }, [rawData]);

      const handleSort = (key) => {
        setSortConfig(prev => ({
          key,
          direction: prev.key === key && prev.direction === 'asc' ? 'desc' : 'asc'
        }));
      };

      const sortedData = useMemo(() => {
        return [...brandData].sort((a, b) => {
          const aVal = a[sortConfig.key];
          const bVal = b[sortConfig.key];
          
          if (sortConfig.direction === 'asc') {
            return aVal - bVal;
          } else {
            return bVal - aVal;
          }
        });
      }, [brandData, sortConfig]);

      const SortIcon = ({ column }) => {
        if (sortConfig.key !== column) {
          return React.createElement('span', { className: "text-white opacity-50 ml-1" }, '‚áÖ');
        }
        return sortConfig.direction === 'asc' ? 
          React.createElement('span', { className: "text-white ml-1" }, '‚Üë') : 
          React.createElement('span', { className: "text-white ml-1" }, '‚Üì');
      };

      const exportToCSV = () => {
        const headers = ['Brand', 'Qwen Avg Rank', 'DeepSeek Avg Rank', 'Gemini Avg Rank', 'Overall Avg Rank', 'Overall Top 5 %'];
        const rows = sortedData.map(row => [
          row.brand,
          row.qwenRank.toFixed(2),
          row.deepseekRank.toFixed(2),
          row.geminiRank.toFixed(2),
          row.overallRank.toFixed(2),
          row.overallTop5.toFixed(1) + '%'
        ]);

        const csvContent = [
          headers.join(','),
          ...rows.map(row => row.join(','))
        ].join('\n');

        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'uk_ev_brand_geo_rankings.csv';
        a.click();
      };

      if (loading) {
        return (
          <div className="w-full min-h-screen bg-gradient-to-br from-gray-50 to-blue-50 flex items-center justify-center">
            <div className="text-center">
              <div className="text-4xl font-black mb-4" style={{ fontFamily: 'Arial Black, sans-serif', color: '#003478' }}>
                LOADING DATA...
              </div>
              <div className="text-gray-600">Fetching live data from Airtable</div>
            </div>
          </div>
        );
      }

      if (error) {
        return (
          <div className="w-full min-h-screen bg-gradient-to-br from-gray-50 to-blue-50 flex items-center justify-center">
            <div className="text-center bg-white p-8 rounded shadow-lg">
              <div className="text-2xl font-black mb-4 text-red-600" style={{ fontFamily: 'Arial Black, sans-serif' }}>
                ERROR LOADING DATA
              </div>
              <div className="text-gray-600">{error}</div>
            </div>
          </div>
        );
      }

      return (
        <div className="w-full min-h-screen bg-gradient-to-br from-gray-50 to-blue-50">
          <div className="text-white py-8 px-6 shadow-2xl border-b-2" style={{ backgroundColor: '#003478', borderBottomColor: '#0055aa' }}>
            <div className="max-w-6xl mx-auto">
              <div className="flex justify-between items-center">
                <div>
                  <h1 className="text-4xl font-black tracking-tight" style={{ fontFamily: 'Arial Black, sans-serif' }}>
                    UK EV BRAND GEO RANKINGS
                  </h1>
                  <p className="text-blue-200 mt-1 text-lg font-semibold">
                    Live Data from Airtable
                  </p>
                </div>
                <div className="bg-green-500 text-white px-4 py-2 rounded font-bold text-sm">
                  ‚óè LIVE
                </div>
              </div>
            </div>
          </div>

          <div className="max-w-6xl mx-auto p-6">
            <div className="bg-white shadow-2xl border-l-4" style={{ borderLeftColor: '#003478' }}>
              <div className="p-6 border-b border-gray-200 flex justify-between items-center">
                <div>
                  <h2 className="text-2xl font-black" style={{ fontFamily: 'Arial Black, sans-serif', color: '#003478' }}>
                    BRAND RANKINGS
                  </h2>
                  <p className="text-sm text-gray-600 mt-1 font-semibold">
                    Lower rank = better position | Top 5 % = percentage of times brand appeared in top 5 overall | Click column headers to sort
                  </p>
                </div>
                <button
                  onClick={exportToCSV}
                  className="flex items-center gap-2 text-white px-6 py-3 hover:opacity-90 transition shadow-lg font-black"
                  style={{ backgroundColor: '#003478', fontFamily: 'Arial Black, sans-serif' }}
                >
                  <Download size={18} />
                  EXPORT CSV
                </button>
              </div>

              <div className="overflow-x-auto">
                <table className="w-full text-sm">
                  <thead>
                    <tr className="text-white border-b-2" style={{ background: 'linear-gradient(to right, #003478, #0055aa)' }}>
                      <th className="text-left p-4 font-black text-base" style={{ fontFamily: 'Arial Black, sans-serif' }}>BRAND</th>
                      <th 
                        className="text-center p-4 font-black text-base cursor-pointer hover:bg-white hover:bg-opacity-10 transition" 
                        style={{ fontFamily: 'Arial Black, sans-serif' }}
                        onClick={() => handleSort('qwenRank')}
                      >
                        QWEN<br/>RANK<SortIcon column="qwenRank" />
                      </th>
                      <th 
                        className="text-center p-4 font-black text-base cursor-pointer hover:bg-white hover:bg-opacity-10 transition" 
                        style={{ fontFamily: 'Arial Black, sans-serif' }}
                        onClick={() => handleSort('deepseekRank')}
                      >
                        DEEPSEEK<br/>RANK<SortIcon column="deepseekRank" />
                      </th>
                      <th 
                        className="text-center p-4 font-black text-base cursor-pointer hover:bg-white hover:bg-opacity-10 transition" 
                        style={{ fontFamily: 'Arial Black, sans-serif' }}
                        onClick={() => handleSort('geminiRank')}
                      >
                        GEMINI<br/>RANK<SortIcon column="geminiRank" />
                      </th>
                      <th 
                        className="text-center p-4 font-black text-base border-l-2 border-white cursor-pointer hover:bg-white hover:bg-opacity-10 transition" 
                        style={{ fontFamily: 'Arial Black, sans-serif', backgroundColor: 'rgba(255,255,255,0.15)' }}
                        onClick={() => handleSort('overallRank')}
                      >
                        OVERALL<br/>RANK<SortIcon column="overallRank" />
                      </th>
                      <th 
                        className="text-center p-4 font-black text-base cursor-pointer hover:bg-white hover:bg-opacity-10 transition" 
                        style={{ fontFamily: 'Arial Black, sans-serif', backgroundColor: 'rgba(255,255,255,0.15)' }}
                        onClick={() => handleSort('overallTop5')}
                      >
                        OVERALL<br/>TOP 5 %<SortIcon column="overallTop5" />
                      </th>
                    </tr>
                  </thead>
                  <tbody>
                    {sortedData.map((row, index) => {
                      const isTop3 = sortConfig.key === 'overallRank' && sortConfig.direction === 'asc' && index < 3;
                      return (
                        <tr 
                          key={row.brand} 
                          className={`border-b border-gray-200 hover:bg-blue-50 transition ${isTop3 ? 'bg-blue-50' : ''}`}
                        >
                          <td className={`p-4 font-bold text-base ${isTop3 ? 'text-lg' : ''}`} style={isTop3 ? { fontFamily: 'Arial Black, sans-serif', color: '#003478' } : { color: '#1a1a1a' }}>
                            {isTop3 && `üèÜ `}{row.brand}
                          </td>
                          <td className="p-4 text-center font-semibold text-base text-gray-700">
                            {row.qwenRank.toFixed(2)}
                          </td>
                          <td className="p-4 text-center font-semibold text-base text-gray-700">
                            {row.deepseekRank.toFixed(2)}
                          </td>
                          <td className="p-4 text-center font-semibold text-base text-gray-700">
                            {row.geminiRank.toFixed(2)}
                          </td>
                          <td className={`p-4 text-center font-black text-lg border-l-2 border-gray-300 ${isTop3 ? 'bg-blue-100' : 'bg-blue-50'}`} style={{ fontFamily: 'Arial Black, sans-serif', color: '#003478' }}>
                            {row.overallRank.toFixed(2)}
                          </td>
                          <td className={`p-4 text-center font-black text-lg ${isTop3 ? 'bg-blue-100' : 'bg-blue-50'}`} style={{ fontFamily: 'Arial Black, sans-serif', color: '#003478' }}>
                            {row.overallTop5.toFixed(1)}%
                          </td>
                        </tr>
                      );
                    })}
                  </tbody>
                </table>
              </div>
            </div>

            <div className="mt-6 bg-white shadow-lg p-6 border-l-4" style={{ borderLeftColor: '#003478' }}>
              <h3 className="text-lg font-black mb-3" style={{ fontFamily: 'Arial Black, sans-serif', color: '#003478' }}>
                KEY INSIGHTS
              </h3>
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                <div className="bg-blue-50 p-4 border-l-2" style={{ borderLeftColor: '#003478' }}>
                  <div className="font-black text-gray-700" style={{ fontFamily: 'Arial Black, sans-serif' }}>BEST OVERALL</div>
                  <div className="text-2xl font-black mt-1" style={{ fontFamily: 'Arial Black, sans-serif', color: '#003478' }}>
                    {sortedData.length > 0 ? sortedData[0].brand : '-'}
                  </div>
                  <div className="text-xs text-gray-600 mt-1">
                    {sortedData.length > 0 ? `Average rank: ${sortedData[0].overallRank.toFixed(2)}` : 'No data'}
                  </div>
                </div>
                <div className="bg-blue-50 p-4 border-l-2" style={{ borderLeftColor: '#003478' }}>
                  <div className="font-black text-gray-700" style={{ fontFamily: 'Arial Black, sans-serif' }}>HIGHEST TOP 5 %</div>
                  <div className="text-2xl font-black mt-1" style={{ fontFamily: 'Arial Black, sans-serif', color: '#003478' }}>
                    {sortedData.length > 0 ? [...sortedData].sort((a, b) => b.overallTop5 - a.overallTop5)[0].brand : '-'}
                  </div>
                  <div className="text-xs text-gray-600 mt-1">
                    {sortedData.length > 0 ? `${[...sortedData].sort((a, b) => b.overallTop5 - a.overallTop5)[0].overallTop5.toFixed(1)}% in top 5` : 'No data'}
                  </div>
                </div>
                <div className="bg-blue-50 p-4 border-l-2" style={{ borderLeftColor: '#003478' }}>
                  <div className="font-black text-gray-700" style={{ fontFamily: 'Arial Black, sans-serif' }}>TOTAL BRANDS</div>
                  <div className="text-2xl font-black mt-1" style={{ fontFamily: 'Arial Black, sans-serif', color: '#003478' }}>
                    {brandData.length}
                  </div>
                  <div className="text-xs text-gray-600 mt-1">Analyzed across all models</div>
                </div>
              </div>
            </div>

            <div className="mt-6 text-center text-sm text-gray-500 pb-6">
              <p>Live data from Airtable | Refreshed: {new Date().toLocaleString()}</p>
            </div>
          </div>
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<SimpleLLMDashboard />);
  </script>
</body>

</html>
